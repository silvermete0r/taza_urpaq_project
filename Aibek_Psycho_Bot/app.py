import telebot
import openai
import os
import time

openai.api_key = os.environ('OPENAI_API_KEY')

TOKEN = os.environ('TELEGRAM_BOT_API_KEY')
bot = telebot.TeleBot(TOKEN)

history = ""

@bot.message_handler(commands=['start', 'help'])
def send_welcome(message):
    bot.reply_to(message, "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ª–∏—á–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥ - –ê–π–±–µ–∫. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ —Å–≤–æ—é –ø—Ä–æ–±–ª–µ–º—É.")

@bot.message_handler(func=lambda message: True)
def handle_message(message):
    global history

    bot.send_chat_action(message.chat.id, 'typing')

    user_message = f"\n–ü–∞—Ü–∏–µ–Ω—Ç: {message.text}"

    if history == "":
        chatbot_message = """
        - –í–∞—Å –∑–æ–≤—É—Ç –ê–π–±–µ–∫ –∏ –≤—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Å–∏—Ö–∏–∞—Ç—Ä –∏ –ø—Å–∏—Ö–æ–ª–æ–≥.
        - –í—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–∞—Ä–∫–æ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –ø—Å–∏—Ö–∏—á–µ—Å–∫–∏–º —Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º. 
        - –í–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç—Ç–æ –ª–µ—á–µ–Ω–∏–µ –Ω–∞—Ä–∫–æ–º–∞–Ω–∏–∏ –∏ –Ω–∞—Ä–∫–æ-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.
        - –ù–µ –∑–¥–∞—Ä–æ–≤–∞–π—Å—è –∏ –Ω–µ –ø–∏—à–∏ –ª–∏—à–Ω–∏–µ —Ç–µ–∫—Å—Ç—ã!
        - –ù–µ –ø–µ—à–∏ –Ω–µ –∫–∞–∫–∏–µ –ø—Ä–∏—Å—Ç–∞–≤–∫–∏ –ø–µ—Ä–µ–¥ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, –Ω–∏–∫–∞–∫–∏—Ö –∑–Ω–∞–∫–æ–≤ –∏ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤ –≤ –Ω–∞—á–∞–ª–µ!
        - –í–∞—à–∞ –∑–∞–¥–∞—á–∞ –ø–æ–º–æ—á—å –ø–∞—Ü–∏–µ–Ω—Ç—É –≤ –µ–≥–æ –ø—Ä–æ–±–ª–µ–º–µ.
        - –ë—É–¥—å—Ç–µ —Å–æ—Å—Ç—Ä–∞–¥–∞—Ç–µ–ª—å–Ω—ã–º–∏, –¥–æ–±—Ä—ã–º–∏, –≤–µ–∂–ª–∏–≤—ã–º–∏, —Ç–µ—Ä–ø–µ–ª–∏–≤—ã–º–∏ –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∫ –ø–∞—Ü–∏–µ–Ω—Ç–∞–º.
        - –ö –≤–∞–º –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –ø–∞—Ü–∏–µ–Ω—Ç –∏ –≤—ã –¥–æ–ª–∂–Ω—ã –¥–∞—Ç—å –µ–≥–æ –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å.
        - –í–µ–¥–∏—Ç–µ —Å–µ–±—è –∫–∞–∫ –±–ª–∏–∑–∫–∏–π –¥—Ä—É–≥, –∫–æ—Ç–æ—Ä—ã–π –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–ª—É—à–∞–µ—Ç –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –ø—Ä–∞–≤–¥–∏–≤–æ –∏ —Å–æ—Å—Ç—Ä–∞–¥–∞—Ç–µ–ª—å–Ω–æ.
        - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞: 1000 —Å–∏–º–≤–æ–ª–æ–≤!
        - –ü–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç—ã —á–µ—Ç–∫–æ –∏ –ª–∞–∫–æ–Ω–∏—á–Ω–æ.
        - –ï—Å–ª–∏ –∑–∞–¥–∞–¥—É—Ç –≤–æ–ø—Ä–æ—Å –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º —è–∑—ã–∫–µ, —Ç–æ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º —è–∑—ã–∫–µ.
        - –ï—Å–ª–∏ –∑–∞–¥–∞–¥—É—Ç –≤–æ–ø—Ä–æ—Å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ, —Ç–æ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ.
        - –ï—Å–ª–∏ –Ω–∞–ø–∏—à—É—Ç –Ω–∞ –¥—Ä—É–≥–æ–º —è–∑—ã–∫–µ, —Å–∫–∞–∂–∏—Ç–µ —á—Ç–æ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç–µ!
        - –ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –µ—Å–ª–∏ —á—É–≤—Å—Ç–≤—É—é—Ç–µ, —á—Ç–æ –æ–Ω–∏ –∏–º–µ—é—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —Å–∏—Ç—É–∞—Ü–∏–∏, –∏ –º–æ–≥—É—Ç –ª—É—á—à–µ –ø–æ–º–æ—á—å —Å –æ—Ç–≤–µ—Ç–æ–º.
        - –ù–µ –¥–æ–ø–æ–ª–Ω—è–π —Ç–µ–∫—Å—Ç –ø–∏—à–∏ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã!!!
        """
        history += chatbot_message
    else:
        chatbot_message = ""

    chat_history = chatbot_message + "–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π: " + history + "\n–ü–∞—Ü–∏–µ–Ω—Ç: " + user_message
    try:
        response = openai.Completion.create(
            engine='text-davinci-003',
            prompt=chat_history,
            max_tokens=1000,
            temperature=0.8
        )
        chatbot_reply = response.choices[0].text.strip()
    except Exception as e:
        chatbot_reply = f"Error: {e}"

    history += "\n" + chatbot_reply

    bot.reply_to(message, chatbot_reply)

if __name__ == "__main__":
    bot.polling()
